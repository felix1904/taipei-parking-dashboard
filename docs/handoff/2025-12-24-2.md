# Session Handoff - 2025-12-24 (第二次)

## 已完成

- **修復 BigQuery 連線錯誤**：`Invalid JWT Signature` 錯誤
  - 原因：`secrets.toml` 中的 `private_key` 格式錯誤
  - 錯誤格式：使用三引號多行格式 `"""..."""`
  - 正確格式：單行格式，換行符號用 `\n` 表示
  - 修復後本機測試成功

## 問題根因

GCP 服務帳號的 JSON 金鑰中，`private_key` 是單行格式（用 `\n` 表示換行）：

```json
"private_key": "-----BEGIN PRIVATE KEY-----\nMIIEuw...\n-----END PRIVATE KEY-----\n"
```

Streamlit 的 `secrets.toml` 需要保持這個格式：

```toml
# ✓ 正確
private_key = "-----BEGIN PRIVATE KEY-----\nMIIEuw...\n-----END PRIVATE KEY-----\n"

# ✗ 錯誤（會導致 Invalid JWT Signature）
private_key = """-----BEGIN PRIVATE KEY-----
MIIEuw...
-----END PRIVATE KEY-----
"""
```

## 待處理

- **Streamlit Cloud 更新**：需要在 Streamlit Cloud 的 Settings → Secrets 貼上新的 secrets.toml 內容
- **金鑰輪換（建議）**：金鑰已在對話中暴露，建議創建新金鑰並刪除舊金鑰

## 關鍵決策

| 決策 | 原因 |
|------|------|
| 使用單行格式 + `\n` | 這是 GCP JSON 金鑰的原生格式，直接複製即可使用 |

## 相關檔案

| 檔案 | 說明 |
|------|------|
| `.streamlit/secrets.toml` | 已修復的憑證設定檔 |

## 技術筆記

### 快速轉換 JSON → TOML

從 GCP 下載的 JSON 金鑰可以直接複製 `private_key` 的值（包含 `\n`），貼到 TOML 檔案中。不需要任何轉換。

### 測試連線的快速指令

```bash
python3 -c "
import toml
from google.oauth2 import service_account
from google.cloud import bigquery

secrets = toml.load('.streamlit/secrets.toml')
credentials = service_account.Credentials.from_service_account_info(secrets['gcp_service_account'])
client = bigquery.Client(credentials=credentials)
print(client.query('SELECT 1').to_dataframe())
"
```
